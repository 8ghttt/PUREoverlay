<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUREoverlayV3_Final</title>
    <style>
        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0; 
            display: flex; justify-content: center; align-items: flex-start; 
            min-height: 100vh; background: transparent; 
            font-family: Arial, sans-serif; overflow: hidden;
        }

        .container {
            text-align: center; position: relative;
            transform: scale(1); transform-origin: top center;
            /* Force GPU rendering to prevent flickering across the whole container */
            transform: translateZ(0); 
        }

        .controller-wrapper {
            position: relative; display: inline-block;
            width: 2000px; height: 2000px;
            contain: strict; 
        }

        .base-layer {
            position: absolute;
            top: 0; left: 0;
            width: 2000px; height: 2000px;
            background-image: url('base.gif');
            background-repeat: no-repeat;
            background-size: contain;
            background-position: center;
            z-index: 0;
            pointer-events: none;
            transform: translateZ(0);
            backface-visibility: hidden;
            will-change: transform;
        }

        .controller.xbox {
            width: 2000px; height: 2000px;
            position: absolute;
            z-index: 1;
        }

        .xbox .trigger, .xbox .bumper, .xbox .back, .xbox .start, .xbox .button, .xbox .face {
            width: 2000px; height: 2000px;
            position: absolute; background-repeat: no-repeat;
            background-size: contain; background-position: center;
            opacity: 0;
            transition: opacity 0.35s ease-in-out; 
        }
        
        .xbox .trigger.left { background-image: url(LT.png); }
        .xbox .trigger.right { background-image: url(RT.png); }
        .xbox .bumper.left { background-image: url(LB.png); }
        .xbox .bumper.right { background-image: url(RB.png); }
        .xbox .back { background-image: url(Select.png); }
        .xbox .start { background-image: url(Start.png); }
        .xbox .a { background-image: url(A.png); }
        .xbox .b { background-image: url(B.png); }
        .xbox .x { background-image: url(X.png); }
        .xbox .y { background-image: url(Y.png); }
        .xbox .face.up { background-image: url(Up.png); }
        .xbox .face.down { background-image: url(Down.png); }
        .xbox .face.left { background-image: url(Left.png); }
        .xbox .face.right { background-image: url(Right.png); }

        .xbox .trigger.pressed, .xbox .bumper.pressed, .xbox .back.pressed, 
        .xbox .start.pressed, .xbox .button.pressed, .xbox .face.pressed {
            opacity: 1;
            transition: none !important; 
        }

        .xbox .sticks { position: absolute; width: 2000px; height: 2000px; top: 0; left: 0; }

        .stick-container {
            position: absolute; width: 250px; height: 250px; 
            perspective: 600px; transform-style: preserve-3d;
        }
        
        .stick-container.left { top: 940px; left: 659px; }
        .stick-container.right { top: 940px; left: 1090px; }

        .xbox .stick {
            position: absolute; width: 250px; height: 250px; 
            background-size: contain; background-repeat: no-repeat;
            background-position: center; transform-origin: center center; 
            will-change: transform; transition: transform 0.05s linear;
        }

        .xbox .stick.left { background-image: url(LSidle.png); }
        .xbox .stick.right { background-image: url(RSidle.png); }

        .xbox .stick::after {
            content: "";
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: contain; background-repeat: no-repeat; background-position: center;
            opacity: 0;
            transition: opacity 0.35s ease-in-out; 
        }

        .xbox .stick.left::after { background-image: url(LS.png); }
        .xbox .stick.right::after { background-image: url(RS.png); }

        .xbox .stick.pressed::after {
            opacity: 1;
            transition: none !important;
        }

        .xbox .stick.shadow-0 { z-index: 0; } 
        .xbox .stick.shadow-1 { z-index: 1; } 
        .xbox .stick.shadow-2 { z-index: 2; }
        .xbox .stick.shadow-3 { z-index: 3; }
        .xbox .stick.main { z-index: 4; }
    </style>
</head>
<body>
    <div class="container">
        <div class="controller-wrapper">
            <div class="base-layer"></div>

            <div class="controller xbox">
                <div class="triggers"><div class="trigger left"></div><div class="trigger right"></div></div>
                <div class="bumpers"><div class="bumper left"></div><div class="bumper right"></div></div>
                <div class="arrows"><div class="back"></div><div class="start"></div></div>
                <div class="abxy"><div class="button a"></div><div class="button b"></div><div class="button x"></div><div class="button y"></div></div>
                
                <div class="sticks">
                    <div class="stick-container left">
                        <div class="stick shadow-0 left"></div><div class="stick shadow-1 left"></div>
                        <div class="stick shadow-2 left"></div><div class="stick shadow-3 left"></div>
                        <div class="stick main left"></div>
                    </div>
                    <div class="stick-container right">
                        <div class="stick shadow-0 right"></div><div class="stick shadow-1 right"></div>
                        <div class="stick shadow-2 right"></div><div class="stick shadow-3 right"></div>
                        <div class="stick main right"></div>
                    </div>
                </div>
                
                <div class="dpad"><div class="face up"></div><div class="face down"></div><div class="face left"></div><div class="face right"></div></div>
            </div>
        </div>
    </div>

    <script>
        let gamepadIndex = null;
        
        const buttonMap = {
            0: '.a', 1: '.b', 2: '.x', 3: '.y', 4: '.bumper.left', 5: '.bumper.right', 
            6: '.trigger.left', 7: '.trigger.right', 8: '.back', 9: '.start', 
            10: '.stick.main.left', 11: '.stick.main.right'
        };

        const controllerElements = {};
        Object.values(buttonMap).forEach(selector => {
            if (!selector.includes('.stick')) {
                controllerElements[selector] = document.querySelector(selector);
            }
        });
        
        controllerElements['.face.up'] = document.querySelector('.face.up');
        controllerElements['.face.down'] = document.querySelector('.face.down');
        controllerElements['.face.left'] = document.querySelector('.face.left');
        controllerElements['.face.right'] = document.querySelector('.face.right');

        const leftStickLayers = document.querySelectorAll('.stick-container.left .stick');
        const rightStickLayers = document.querySelectorAll('.stick-container.right .stick');
        
        function applyStickPhysics(element, x, y, TRAVEL_FACTOR, TILT_FACTOR, layerIndex) {
            if (Math.abs(x) < 0.1) x = 0;
            if (Math.abs(y) < 0.1) y = 0;
            const moveX = x * (42 * TRAVEL_FACTOR);
            const moveY = y * (42 * TRAVEL_FACTOR);
            const rotateX = y * (30 * TILT_FACTOR); 
            const rotateY = x * (30 * TILT_FACTOR);
            const z = 4 * layerIndex;
            // Using translate3d for better GPU performance
            element.style.transform = `translate3d(${moveX}px, ${moveY}px, ${-z}px) rotateX(${-rotateX}deg) rotateY(${rotateY}deg)`;
        }

        function updateStatus() {
            if (gamepadIndex === null) return;
            const gamepad = navigator.getGamepads()[gamepadIndex];
            if (!gamepad) return;

            gamepad.buttons.forEach((button, index) => {
                const selector = buttonMap[index];
                if (selector && selector.includes('.stick.main')) {
                    const side = selector.includes('left') ? '.left' : '.right';
                    document.querySelectorAll('.stick-container' + side + ' .stick')
                            .forEach(el => button.pressed ? el.classList.add('pressed') : el.classList.remove('pressed'));
                } else if (controllerElements[selector]) {
                    // Preserved original sensitivity logic
                    const isPressed = button.pressed || (index >= 6 && index <= 7 && button.value > 0.1); 
                    isPressed ? controllerElements[selector].classList.add('pressed') : controllerElements[selector].classList.remove('pressed');
                }
            });

            // Preserved original D-Pad Axis support
            const AXIS_DPAD_X = gamepad.axes[6] !== undefined ? gamepad.axes[6] : (gamepad.axes[4] || 0); 
            const AXIS_DPAD_Y = gamepad.axes[7] !== undefined ? gamepad.axes[7] : (gamepad.axes[5] || 0); 
            
            const up = (gamepad.buttons[12] && gamepad.buttons[12].pressed) || AXIS_DPAD_Y < -0.5;
            const down = (gamepad.buttons[13] && gamepad.buttons[13].pressed) || AXIS_DPAD_Y > 0.5;
            const left = (gamepad.buttons[14] && gamepad.buttons[14].pressed) || AXIS_DPAD_X < -0.5;
            const right = (gamepad.buttons[15] && gamepad.buttons[15].pressed) || AXIS_DPAD_X > 0.5;

            up ? controllerElements['.face.up'].classList.add('pressed') : controllerElements['.face.up'].classList.remove('pressed');
            down ? controllerElements['.face.down'].classList.add('pressed') : controllerElements['.face.down'].classList.remove('pressed');
            left ? controllerElements['.face.left'].classList.add('pressed') : controllerElements['.face.left'].classList.remove('pressed');
            right ? controllerElements['.face.right'].classList.add('pressed') : controllerElements['.face.right'].classList.remove('pressed');

            const STACK_FACTORS = [1.0, 0.96, 0.92, 0.88, 0.84]; 
            leftStickLayers.forEach((el, i) => applyStickPhysics(el, gamepad.axes[0], gamepad.axes[1], STACK_FACTORS[i], STACK_FACTORS[i], i));
            rightStickLayers.forEach((el, i) => applyStickPhysics(el, gamepad.axes[2], gamepad.axes[3], STACK_FACTORS[i], STACK_FACTORS[i], i));

            requestAnimationFrame(updateStatus);
        }

        window.addEventListener('gamepadconnected', (e) => { 
            gamepadIndex = e.gamepad.index; 
            updateStatus(); 
        });
        
        window.addEventListener('gamepaddisconnected', (e) => { 
            if (gamepadIndex === e.gamepad.index) gamepadIndex = null; 
        });
    </script>
</body>
</html>